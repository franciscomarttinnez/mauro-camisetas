<!DOCTYPE html>
<html lang="es">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Catálogo | Mauro Camisetas</title>
	<meta name="description" content="Catálogo online de Mauro Camisetas: buscá por nombre o club y abrí cada producto para ver fotos y comprar por WhatsApp o Instagram.">
	<meta name="robots" content="index,follow">
	<meta name="author" content="Mauro Camisetas">
	<link rel="canonical" href="https://maurocamisetasoficial.netlify.app/catalogo.html">
	<meta property="og:type" content="website">
	<meta property="og:site_name" content="Mauro Camisetas">
	<meta property="og:title" content="Catálogo | Mauro Camisetas">
	<meta property="og:description" content="Buscá camisetas y productos. Ver fotos y comprar por WhatsApp o Instagram.">
	<meta property="og:url" content="https://maurocamisetasoficial.netlify.app/catalogo.html">
	<meta property="og:image" content="https://maurocamisetasoficial.netlify.app/assets/og-image.jpg">
	<meta property="og:locale" content="es_AR">
	<meta name="twitter:card" content="summary_large_image">
	<meta name="theme-color" content="#3396D3">
	<link rel="icon" type="image/png" sizes="32x32" href="./assets/favicon-32.png">
	<link rel="icon" type="image/png" sizes="16x16" href="./assets/favicon-16.png">
	<link rel="apple-touch-icon" sizes="180x180" href="./assets/apple-touch-icon.png">
	<link rel="icon" type="image/x-icon" href="./assets/images.png">
	<link rel="preconnect" href="https://fonts.googleapis.com">
	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link href="https://fonts.googleapis.com/css2?family=Zalando+Sans+Expanded:ital,wght@0,200..900;1,200..900&display=swap" rel="stylesheet">

	<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css"
		rel="stylesheet"
		integrity="sha384-sRIl4kxILFvY47J16cr9ZwB07vP4J8+LH7qKQnuqkuIAvNWLzeN8tE5YBujZqJLB"
		crossorigin="anonymous">
	<link rel="stylesheet" href="styles.css">
</head>
<body class="bg-light">


	<nav class="navbar navbar-expand-md navbar-light bg-light border-bottom shadow">
		<div class="container">
			<a class="navbar-brand d-flex align-items-center gap-2" href="index.html">
				<img src="./assets/images.png" alt="Logo" width="36" height="36">
				<span class="fw-semibold">Mauro Camisetas</span>
			</a>

			<button class="navbar-toggler" type="button"
				data-bs-toggle="collapse" data-bs-target="#mainNav"
				aria-controls="mainNav" aria-expanded="false" aria-label="Toggle navigation">
				<span class="navbar-toggler-icon"></span>
			</button>

			<div id="mainNav" class="collapse navbar-collapse">
				<ul class="navbar-nav ms-auto">
					<li class="nav-item"><a class="nav-link" href="index.html#local">Local</a></li>
					<li class="nav-item"><a class="nav-link" href="index.html#novedades">Novedades</a></li>
					<li class="nav-item"><a class="nav-link" href="index.html#faltante">Contacto</a></li>
				</ul>
			</div>
		</div>
	</nav>

	<main class="py-4">
		<section class="py-4">
			<div class="container">
				<div class="d-flex flex-column flex-md-row align-items-md-center justify-content-between gap-3 mb-3">
					<h1 class="h4 m-0">Catálogo</h1>
					<a href="index.html" class="btn btn-outline-success btn-sm">Volver al inicio</a>
				</div>
<div class="row align-items-center g-3 mb-4">
	<div class="col-md-6">
		<div class="input-group">
			<span class="input-group-text bg-success text-white">Buscar</span>
			<input type="text" id="buscador" class="form-control" placeholder="Nombre o club...">
		</div>
	</div>

	<div class="col-md-3">
		<select id="filtroEtiqueta" class="form-select">
			<option value="">Todas las etiquetas</option>
			<option value="Nuevo">Nuevos</option>
			<option value="Promo">Promos</option>
		</select>
	</div>

	<div class="col-md-3">
		<select id="ordenPrecio" class="form-select">
			<option value="">Ordenar por precio</option>
			<option value="asc">Menor a mayor</option>
			<option value="desc">Mayor a menor</option>
		</select>
	</div>
</div>


				<div id="gridProductos" class="row g-3 g-sm-4"></div>
			</div>
		</section>
	</main>

	<div class="modal fade" id="modalProducto" tabindex="-1" aria-hidden="true">
		<div class="modal-dialog modal-lg modal-dialog-centered">
			<div class="modal-content">
				<div class="modal-header">
					<h5 class="modal-title" id="modalTitulo"></h5>
					<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
				</div>
				<div class="modal-body">
					<div id="modalCarousel" class="carousel slide mb-3" data-bs-ride="carousel">
						<div class="carousel-inner" id="modalImagenes"></div>
						<button class="carousel-control-prev" type="button" data-bs-target="#modalCarousel" data-bs-slide="prev">
							<span class="carousel-control-prev-icon"></span>
						</button>
						<button class="carousel-control-next" type="button" data-bs-target="#modalCarousel" data-bs-slide="next">
							<span class="carousel-control-next-icon"></span>
						</button>
					</div>
					<p id="modalDescripcion" class="mb-2"></p>
					<p class="mb-1"><strong>Talles:</strong> <span id="modalTalles"></span></p>
					<p class="mb-0"><strong>Precio:</strong> $<span id="modalPrecio"></span></p>
				</div>
				<div class="modal-footer">
					<a id="modalWhatsapp" class="btn btn-success" target="_blank" rel="noopener">Comprar por WhatsApp</a>
					<a id="modalInstagram" class="btn btn-outline-danger" target="_blank" rel="noopener">Ver en Instagram</a>
				</div>
			</div>
		</div>
	</div>


	<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js"></script>


<script>
const CATALOGO_URL = "https://raw.githubusercontent.com/franciscomarttinnez/mauro-camisetas/main/content/catalogo.json";
const CACHE_KEY = "catalogo_v1";
const CACHE_TTL_MS = 5 * 60 * 1000; // 5 minutos

const grid = document.getElementById("gridProductos");
const buscador = document.getElementById("buscador");
const filtroEtiqueta = document.getElementById("filtroEtiqueta");
const ordenPrecio = document.getElementById("ordenPrecio");

let productos = [];
let productosFiltrados = [];

/* ====== Cache helpers ====== */
function loadCache() {
	try {
		const raw = localStorage.getItem(CACHE_KEY);
		if (!raw) return null;
		const { ts, items } = JSON.parse(raw);
		if (!ts || Date.now() - ts > CACHE_TTL_MS) return null; // vencido
		if (!Array.isArray(items)) return null;
		return items;
	} catch { return null; }
}
function saveCache(items) {
	try {
		localStorage.setItem(CACHE_KEY, JSON.stringify({ ts: Date.now(), items }));
	} catch {}
}

/* ====== Normalizadores ====== */
function aRaw(url) {
	if (!url) return url;
	let m = url.match(/^https:\/\/cdn\.jsdelivr\.net\/gh\/([^/]+)\/([^@]+)@([^/]+)\/(.+)$/);
	if (m) return `https://raw.githubusercontent.com/${m[1]}/${m[2]}/${m[3]}/${m[4]}`;
	m = url.match(/^https:\/\/[^.]+\.github\.io\/[^/]+\/(.+)$/);
	if (m) return `https://raw.githubusercontent.com/franciscomarttinnez/mauro-camisetas/main/${m[1]}`;
	return url;
}
function toJsDelivr(urlRaw) {
	// raw.githubusercontent.com/USER/REPO/BRANCH/path -> cdn.jsdelivr.net/gh/USER/REPO@BRANCH/path
	const m = urlRaw && urlRaw.match(/^https:\/\/raw\.githubusercontent\.com\/([^/]+)\/([^/]+)\/([^/]+)\/(.+)$/);
	return m ? `https://cdn.jsdelivr.net/gh/${m[1]}/${m[2]}@${m[3]}/${m[4]}` : urlRaw;
}
function normalizarTalles(raw) {
	if (!Array.isArray(raw)) return [];
	return raw.map(t => (typeof t === "object" && t.talle) ? t.talle : t);
}
function normalizarImagenes(raw) {
	if (!Array.isArray(raw)) return [];
	return raw.map(img => {
		const url = (typeof img === "object" && img.imagen) ? img.imagen : img;
		return aRaw(url); // preferimos RAW (instantáneo)
	});
}

/* ====== UI ====== */
function cardProducto(p, i) {
	const primera = p.imagenes?.[0] || "./assets/og-image.jpg";
	const primary = aRaw(primera);
	const fallback = toJsDelivr(primary);
	const badge = p.etiqueta
		? `<span class="position-absolute top-0 start-0 m-2 badge ${p.etiqueta === 'Promo' ? 'bg-danger' : 'bg-success'}">${p.etiqueta}</span>`
		: "";
	return `
	<div class="col-6 col-md-4 col-lg-3">
		<div class="card h-100 shadow-sm border-0 position-relative" role="button"
			 data-index="${i}" data-bs-toggle="modal" data-bs-target="#modalProducto">
			${badge}
			<div class="ratio ratio-1x1">
				<img src="${primary}" data-fallback="${fallback}"
				     class="rounded-top object-fit-cover" alt="${p.nombre}"
				     loading="lazy"
				     onerror="if(this.dataset.fallback){ this.src=this.dataset.fallback; this.dataset.fallback=''; } else { this.src='./assets/og-image.jpg'; }">
			</div>
			<div class="card-body text-center py-3">
				<h6 class="fw-bold mb-1">${p.nombre}</h6>
				<p class="text-muted mb-0 small">${p.club}</p>
			</div>
		</div>
	</div>`;
}
function renderProductos() {
	grid.innerHTML = productosFiltrados.map((p, i) => cardProducto(p, i)).join("");
}
function aplicarFiltros() {
	const q = buscador.value.trim().toLowerCase();
	const etiqueta = filtroEtiqueta.value;
	const orden = ordenPrecio.value;

	productosFiltrados = productos.filter(p => {
		const matchTexto = p.nombre.toLowerCase().includes(q) || p.club.toLowerCase().includes(q);
		const matchEtiqueta = etiqueta ? p.etiqueta === etiqueta : true;
		return matchTexto && matchEtiqueta;
	});
	if (orden === "asc") productosFiltrados.sort((a, b) => a.precio - b.precio);
	if (orden === "desc") productosFiltrados.sort((a, b) => b.precio - a.precio);

	renderProductos();
}
buscador.addEventListener("input", aplicarFiltros);
filtroEtiqueta.addEventListener("change", aplicarFiltros);
ordenPrecio.addEventListener("change", aplicarFiltros);

grid.addEventListener("click", (e) => {
	const card = e.target.closest("[data-index]");
	if (!card) return;
	const p = productosFiltrados[card.dataset.index];

	document.getElementById("modalTitulo").textContent = p.nombre || "";
	document.getElementById("modalDescripcion").textContent = p.descripcion || "";
	document.getElementById("modalTalles").textContent = (p.talles || []).join(", ");
	document.getElementById("modalPrecio").textContent = Number(p.precio || 0).toLocaleString("es-AR");
	document.getElementById("modalWhatsapp").href = p.whatsapp || "#";
	document.getElementById("modalInstagram").href = p.instagram || "#";

	const cont = document.getElementById("modalImagenes");
	const imgs = p.imagenes && p.imagenes.length ? p.imagenes : ["./assets/og-image.jpg"];
	cont.innerHTML = imgs.map((src, i) => {
		const primary = aRaw(src);
		const fallback = toJsDelivr(primary);
		return `
			<div class="carousel-item ${i === 0 ? "active" : ""}">
				<img src="${primary}" data-fallback="${fallback}"
					 class="d-block w-100" alt="" loading="lazy"
					 onerror="if(this.dataset.fallback){ this.src=this.dataset.fallback; this.dataset.fallback=''; } else { this.src='./assets/og-image.jpg'; }">
			</div>`;
	}).join("");
});

/* ====== Carga: cache inmediato + red con retry + fallback a cache vencido ====== */
function mapearItems(items) {
	return items.map(item => ({
		nombre: item.nombre || "",
		club: item.club || "",
		precio: Number(item.precio || 0),
		talles: normalizarTalles(item.talles),
		descripcion: item.descripcion || "",
		imagenes: normalizarImagenes(item.imagenes),
		whatsapp: item.whatsapp || "",
		instagram: item.instagram || "",
		etiqueta: item.etiqueta || ""
	}));
}

// hasta 3 intentos con esperas crecientes
async function fetchCatalogo() {
	const tries = 3, delay = (i) => 500 * (i + 1);
	for (let i = 0; i < tries; i++) {
		try {
			const url = `${CATALOGO_URL}?ts=${Date.now()}`;
			const res = await fetch(url, { cache: "no-store" });
			if (res.ok) return await res.json();
		} catch {}
		if (i < tries - 1) await new Promise(r => setTimeout(r, delay(i)));
	}
	throw new Error("fetch failed");
}

async function cargarCatalogo() {
	// 1) Render inmediato desde cache si existe
	const cachedFresh = loadCache();
	if (cachedFresh) {
		productos = mapearItems(cachedFresh);
		productosFiltrados = productos.slice();
		renderProductos();
	}

	// 2) Intentar red con retry; si falla y no había cache fresco, usar cache vencido
	try {
		const data = await fetchCatalogo();
		const items = Array.isArray(data?.items) ? data.items : [];
		const mapeado = mapearItems(items);

		if (!cachedFresh || JSON.stringify(cachedFresh) !== JSON.stringify(items)) {
			productos = mapeado;
			productosFiltrados = productos.slice();
			renderProductos();
			saveCache(items);
		}
	} catch (err) {
		// fallback a cache vencido (si existe) cuando la red falla y no había cache fresco
		const raw = localStorage.getItem(CACHE_KEY);
		let expired = null;
		try { expired = raw ? JSON.parse(raw).items : null; } catch {}
		if (expired && !cachedFresh) {
			productos = mapearItems(expired);
			productosFiltrados = productos.slice();
			renderProductos();
		} else if (!cachedFresh) {
			grid.innerHTML = `
				<div class="col-12">
					<div class="alert alert-warning">
						No pudimos cargar el catálogo. Verificá tu conexión e intentá nuevamente.
					</div>
				</div>`;
		}
		console.error("No se pudo cargar el catálogo:", err);
	}
}

cargarCatalogo();
</script>




</body>
</html>
